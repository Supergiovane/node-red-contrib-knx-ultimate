{% assign active_lang = include.lang | default: site.active_lang | default: 'en' %}
{% assign nav_entries = site.data['wiki-nav'][active_lang] %}
{% assign languages = site.data.languages %}
{% assign lang_label = site.data.translations.language_label[active_lang] | default: 'Language' %}
<nav class="wiki-nav">
  <div class="wiki-nav__languages" role="navigation" aria-label="{{ lang_label }}">
    <span class="wiki-nav__languages-label">üåê {{ lang_label }}</span>
    {% for code in languages %}
      {% assign lang_code = code[0] %}
      {% assign lang_info = code[1] %}
      {% assign prefix = lang_info.prefix %}
      {% if prefix == '' %}
        {% assign candidate_title = page.title %}
      {% else %}
        {% assign candidate_title = prefix | append: page.title %}
      {% endif %}
      {% assign candidate_slug = candidate_title | uri_escape %}
      {% assign candidate_url = '/wiki/' | append: candidate_slug %}
      {% assign page_exists = false %}
      {% for p in site.pages %}
        {% if p.url == candidate_url %}
          {% assign page_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% unless page_exists %}
        {% assign fallback_slug = page.title | uri_escape %}
        {% assign candidate_url = '/wiki/' | append: fallback_slug %}
      {% endunless %}
      {% if lang_code == active_lang %}
        <span class="wiki-nav__language wiki-nav__language--active">{{ lang_info.short | default: lang_info.label }}</span>
      {% else %}
        <a class="wiki-nav__language" href="{{ candidate_url | relative_url }}">{{ lang_info.short | default: lang_info.label }}</a>
      {% endif %}
    {% endfor %}
  </div>
  {% if nav_entries %}
    {% assign current_url = page.url %}
    <div class="wiki-nav__groups">
        {% for section in nav_entries %}
          {% assign section_open = false %}
          {% for link in section.items %}
            {% if link.external != true and link.url == current_url %}
              {% assign section_open = true %}
            {% endif %}
          {% endfor %}
          <details class="wiki-nav__group" {% if section_open or forloop.first %}open{% endif %}>
            <summary>{{ section.title }}</summary>
            <ul class="wiki-nav__list">
              {% for item in section.items %}
                {% assign is_active = false %}
                {% if item.external != true and item.url == current_url %}
                  {% assign is_active = true %}
                {% endif %}
                <li>
                  {% if item.external %}
                    <a class="wiki-nav__link" href="{{ item.url }}" rel="noopener">{{ item.label }}</a>
                  {% else %}
                    <a class="wiki-nav__link{% if is_active %} wiki-nav__link--active{% endif %}" href="{{ item.url | relative_url }}">{{ item.label }}</a>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </details>
      {% endfor %}
    </div>
  {% endif %}
</nav>
